/**
  @rely: jQuery
  @author: da宗熊
  @version: 0.0.4
  @lastModify: 2017/6/20
  @git: https://github.com/linfenpan/spa#readme
*/
!function(e,t){"function"==typeof define?define.amd?define(t):define.cmd&&define(function(e,n,r){r.exports=t()}):e.SPA=t()}(this,function(){"use strict";function e(e,t){for(var n in e)e.hasOwnProperty(n)&&t.call(e,e[n],n);return e}function t(e){return[].slice.call(e,0)}function n(e){return $.type(e)}function r(e,t){if(d.isAbsolute(e))return e;var n=location.href;return t=t||n,d.isAbsolute(t)||(t=r(t,n)),t=d.dir(t),d.join(t,e)}function i(e){return e.replace(/(\?|#).*$/,"")}function o(){return m++}function a(e){this.key=e,this.keyBack=e+"-back",this.keyForward=e+"-forward",this.current=null,this.bindEvent(),this.init()}function s(e,t){this.key=e,this.waitTime=t||300,this.isRunning=!1,this.runTimer=null,this.prevFn=null}function c(e){var t=this;t.map={},t.split=e||"-",t.args=[]}function u(e,t){var n=this;h.call(n),n.$root=e,n.opts=$.extend({key:"pjax",cache:!0,animateTime:300,fireInitEvent:!0},t||{});var r=n.key=n.opts.key;n.keyContainer="data-"+r+"-container",n.keyIgnore="data-"+r+"-ignore",n.keyResource="data-"+r+"-res",n.keyCurrent="data-"+r+"-current",n.keyId="data-"+r+"-id",n.ajax=null,n.lockAjax=!1,f&&(n.init(),n.bindEvent())}var f="pushState"in history&&!!window.sessionStorage;if(window.sessionStorage)try{sessionStorage.setItem("__pajax",1),sessionStorage.removeItem("__pajax")}catch(d){f=!1}var d={normal:function(e){return e.replace(/\/\.\//g,"//").replace(/(^|[^:])\/{2,}/g,"$1/").replace(/[^/]*\/\.\.\/([^/]*)/g,"$1")},isAbsolute:function(e){return/((https?|ftp):)?\/\//.test(e)},join:function(){var e=[].slice.call(arguments,0),t=e.shift(),n="/",r=!1,i="/";d.isAbsolute(t)&&(n=/.*?:?\/\/[^/]+\/?/.exec(t)[0]+"/",r=/^.*?:?\/\/[^/]+\/?$/.test(t)),r&&(i=n,n="/",t="/");for(var o=e.shift();o;){if(d.isAbsolute(o))return t=o,e.unshift(t),d.join.apply(d,e);t=/^\//.test(o)?d.normal(n+"/"+o):d.normal(d.dir(t)+"/"+o),o=e.shift()}return r?d.normal(i+"./"+t):t},dir:function(e){return e=i(e),d.isDir(e)?d.normal(e):d.normal(e.replace(/(.*\/).*$/,"$1"))},isDir:function(e){return e=d.normal(e),!/(?:[^/])\/[^/]+\.[^/]+$/.test(e)},root:function(e){var t=e.match(/.*:\/{2,}.*?(\/|$)/g);return t?t[0]:""},ext:function(e){return(e=i(e)).match(/\.([^.]*)$/)[1]}},h=function(){this._=$("<div></div>")};h.prototype={on:function(e,n,r){var i=this,o=n._e_on_fn_||function(){var e=t(arguments);return e.shift(),n.apply(i,e)};return i._[r?"one":"on"](e,o),i},off:function(e,t){return this._.off(e,t?t._e_on_fn_||t:t),this},one:function(e,t){return this.on(e,t,!0)},fire:function(){return this._.trigger.apply(this._,arguments),this}};var l=new h,p={elHead:null,map:{},init:function(){var e=this;e.elHead=document.head||document.getElementsByTagName("head")[0],e.init=function(){},$("script,link").each(function(t,n){var r=n.src||n.href;e._setExist(r)})},_setExist:function(e){e&&(d.isAbsolute(e)||(e=r(e)),this.map[e]=1)},_addResource:function(e,t,n,i){var o=this;if(n=n||o.elHead,t){if(i=void 0===i||i,t=r(t),i&&o.map[t])return;n.appendChild(e),i&&o._setExist(t)}else n.appendChild(e)},addScripts:function(t,n){var r=this,i=[];r.init(),e(t,function(t){var n=t.dom,o=t.pos,a=t.ignoreRepeat;if(n){var s=document.createElement("script");if(!n.src)return s.innerHTML=$(n).html(),void $.when.apply($,i.slice(0)).always(function(){r._addResource(s,s.src,o,a)});if(e(n.attributes,function(e){var t=e.name||e.nodeName||e;s.setAttribute(t,n.getAttribute(t))}),!a||!r.map[n.src]){var c=$.Deferred();s.addEventListener("load",c.resolve,!1),s.addEventListener("error",c.resolve,!1),i.push(c)}$.when.apply($,i.slice(0,-1)).always(function(){r._addResource(s,s.src,o,a)})}}),$.when.apply($,i.slice(0)).always(function(){n&&n()})},addLinks:function(t){var n=this;n.init(),e(t,function(e){var t=e.dom;n._addResource(t,t.href,e.pos,e.ignoreRepeat)})}};$(function(){p.init()});var y=sessionStorage,m=new Date/1;a.prototype={init:function(){if(!this.current){var e=JSON.parse(y.getItem(this.keyBack)||"[]");this.current=e[e.length-1]}},bindEvent:function(){var e=this;window.addEventListener("popstate",function(t){var n=t.state;if(!n||!n.id)return!0;e.onStateChange(n)})},clear:function(){y.setItem(this.keyBack,"[]"),y.setItem(this.keyForward,"[]")},_getList:function(e){return JSON.parse(y.getItem(e)||"[]")},_setList:function(e,t){y.setItem(e,JSON.stringify(t||[]))},push:function(e,t){var n=this,r=n.current,i=$.extend({key:n.key,id:o(),url:e},t||{});history.pushState(i,"",e),n._push(i),l.fire("pushstate",[{key:n.key,from:r,to:i,back:n._getList(n.keyBack),forward:[]}])},_push:function(e){var t=this,n=t._getList(t.keyBack);n.push(e),y.setItem(t.keyBack,JSON.stringify(n)),t._setList(t.keyForward,[]),t.current=e},replace:function(e,t){var n=this,r=n.current,i=$.extend({key:n.key,id:o(),url:e},t||{});history.replaceState(i,"",e),this._replace(i),l.fire("replacestate",[{key:n.key,from:r,to:i,back:n._getList(n.keyBack),forward:n._getList(n.keyForward)}])},_replace:function(e){var t=this,n=t._getList(t.keyBack);n[Math.max(0,n.length-1)]=e,t._setList(t.keyBack,n),t.current=e},_back:function(e){var t=this;t.current=e;var n=t._getList(t.keyBack);n.pop(),t._setList(t.keyBack,n),(n=t._getList(t.keyForward)).unshift(e),t._setList(t.keyForward,n)},_forward:function(e){var t=this;t.current=e;var n=t._getList(t.keyBack);n.push(e),t._setList(t.keyBack,n),(n=t._getList(t.keyForward)).shift(),t._setList(t.keyForward,n)},onStateChange:function(e){var t=this,n=!1,r=t.current;r&&r.id!==e.id&&(r.id>e.id?(n=!0,t._back(e)):t._forward(e)),l.fire("popstate",[{key:t.key,from:r,to:e,isBack:n,back:t._getList(t.keyBack),forward:t._getList(t.keyForward)}])}},s.prototype={getCls:function(e){var t=this.key,n=t+"-"+e;return{beforeShow:n+"-before-show "+t+"-before-show pjax-before-show",show:n+"-show "+t+"-show pjax-show",beforeHide:n+"-before-hide "+t+"-before-hide pjax-before-hide",hide:n+"-hide "+t+"-hide pjax-hide"}},clearCls:function(e){var t=e[0];if(t){var n=new RegExp("(\\s+)"+this.key+"(-[^-]+)+-(show|hide)\\s*","g");t.className=t.className.replace(n,"$1")}},animate:function(e,t,n,r){var i=this,o=i.getCls(e);i.clearCls(t),i.clearCls(n),t.addClass(o.beforeHide),n.addClass(o.beforeShow),t[0]&&t[0].clientWidth,n[0]&&n[0].clientWidth,clearTimeout(i.runTimer),i.isRunning&&i.prevFn&&i.prevFn(),i.prevFn=function(){i.isRunning=!1,t.addClass(o.hide),n.addClass(o.show),r&&r()},i.isRunning=!0,i.runTimer=setTimeout(i.prevFn,i.waitTime)}},c.prototype={params:function(){return this.args=t(arguments),this},add:function(){var e=t(arguments),r=e.pop();if("function"==n(r)){var i=this;return i.map[e.join(i.split)]=r,i}},run:function(){var e=this,n=t(arguments),r=e.map[n.join(e.split)];return r&&r.apply(null,e.args),e}};var k="dom:destroy";return u.prototype=$.extend({init:function(){var e=this,t=this.$root,n=this.opts,r=t.find("["+e.keyContainer+"]");if(r.length>1)throw"["+e.keyContainer+"] 元素，同一个页面，不能有多个";var i=e.history=new a(e.key);if(history.state||i.clear(),i.replace(location.href),r.length>0){var o=i.current;e._setDomIdByConf(r,o),e._setDomState(r,!0),n.fireInitEvent&&setTimeout(function(){e.fire("pjax:render",[r]),e.fire("dom:ready",[r])})}e.clsCtrl=new s(e.key,n.animateTime),e.stateRunner=new c,e.initRunner()},initRunner:function(){var e=this,t=e.stateRunner,n="history";t.add(n,"push",function(t){e.history.push(t)}),t.add(n,"replace",function(t){e.history.replace(t)}),n="dom",t.add(n,"push",function(t,n){e._setDomIdByConf(n,e.history.current)}),t.add(n,"replace",function(t,n){e.fire("dom:destroy",[t]),t.remove(),e._setDomIdByConf(n,e.history.current)})},_setDomIdByConf:function(e,t){e.attr(this.keyId,t.id)},_setDomState:function(e,t){t?e.attr(this.keyCurrent,!0):e.removeAttr(this.keyCurrent)},bindEvent:function(){function t(t){var r={};e([].concat(t.back||[],t.forward||[]),function(e){r[e.id]=1}),n.$root.find("["+n.keyId+"]").each(function(e,t){var i=$(t),o=i.attr(n.keyId);r[o]||setTimeout(function(){n.fire(k,[i]),i.remove()},n.opts.animateTime)})}var n=this,r=n.opts.key;l.on("pushstate",function(e){e&&e.key==r&&t(e)}),l.on("popstate",function(e){if(e&&e.key==r&&e.to){t(e);var i=e.to.url,o=e.isBack?"back":"forward",a=n.$root.find("["+n.keyId+"="+e.to.id+"]");a.length>0?n._addContent({$dom:a},o):n._load(i,o,!0)}})},back:function(e){history.back()},forward:function(e){history.forward()},push:function(e,t){f?this._load(e,"push",!1,t):location.href=e},replace:function(e,t){f?this._load(e,"replace",!1,t):location.replace(e)},reload:function(e,t){"boolean"==typeof e&&(t=e,e=void 0),f?this._load(e||location.href,"replace",!0,t):location.reload()},_load:function(e,i,o,a){var s=this;"object"===n(e)&&(e=e.href||"");var c=r(e);if((o||c!==location.href)&&!s.lockAjax)return s.fire("pjax:request",[c].concat(t(arguments))),s.ajax&&s.ajax.abort(),s.ajax=$.ajax({url:c,type:"GET",cache:void 0===a?s.opts.cache:a,dataType:"html"}).always(function(){s.fire("pjax:complete",[c].concat(t(arguments)))}).done(function(e){s.fire("pjax:success",[c].concat(t(arguments))),s.handlerSuccess(c,i,e)}).fail(function(){s.fire("pjax:failure",[c].concat(t(arguments)))}),s.ajax},handlerSuccess:function(e,t,n){var r=this;r.lockAjax=!0;try{var i=r._analysisiHtml(n,e);if(!i.$dom||i.$dom.length<=0)return r.lockAjax=!1,void r.fire("pjax:parseerror",[e,n]);var o=r.stateRunner;o.params(e).run("history",t),r._addContent(i,t,function(e,n){r.lockAjax=!1,o.params(e,n).run("dom",t)})}catch(t){r.lockAjax=!1,r.fire("pjax:parseerror",[e,n])}},_analysisiHtml:function(e,t){var n=this,i=document.head||document.getElementsByTagName("head")[0],o=e.match(/<body[^>]*>([\s\S.]*)<\/body>/),a=e.match(/<head[^>]*>([\s\S.]*)<\/head>/),s=[],c=[],u=null,f=null,d=null;o&&(f=$("<div>"+o[1]+"</div>")),a&&(d=$("<div>"+a[1]+"</head>"));var h="link["+n.keyIgnore+"],style["+n.keyIgnore+"],script["+n.keyIgnore+"]",l=function(e,i){var o=e.getAttribute(n.keyResource);return e.href?e.setAttribute("href",r(e.getAttribute("href"),t)):e.src&&e.setAttribute("src",r(e.getAttribute("src"),t)),{dom:e,pos:i,ignoreRepeat:0==o||!o}};return d&&(f.find(h).remove(),d.find("style,link,script").each(function(e,t){var n=c;"script"===t.tagName.toLowerCase()&&(n=s),n.push(l(t,i))})),f&&(f.find(h).remove(),u=f.find("["+n.keyContainer+"]"),f.find("script").map(function(e,t){$(t),u.find(t).length>0?(t.setAttribute(n.keyResource,t.getAttribute(n.keyResource)||1),s.push(l(t,u[0]))):t.hasAttribute(n.keyResource)&&s.push(l(t,i))}),u.find("script").remove(),u.remove(),f.find("style,link").each(function(e,t){t.hasAttribute(n.keyResource)&&c.push(l(t,i))})),{scripts:s,links:c,$dom:u}},_addContent:function(e,t,n){var r=this;if(e.$dom&&1===e.$dom.length){r.$root.append(e.$dom);var i=e.$dom,o=r.$root.find("["+r.keyCurrent+"]"),a=$.Deferred(),s=$.Deferred();p.addScripts(e.scripts,function(){a.resolve()}),p.addLinks(e.links),$.when(a,s).always(function(){r.fire("pjax:render",[i]),r.fire("dom:ready",[i])}),r.fire("dom:beforeshow",[i]),r.fire("dom:beforehide",[o]),r.clsCtrl.animate(t||"replace",o,i,function(){r._setDomState(i,!0),r._setDomState(o,!1),r.fire("dom:show",[i]),r.fire("dom:hide",[o]),s.resolve(),n&&n(o,i)})}else console.error("缺少 dom 元素")}},h.prototype),$.pjax=function(e,t){return new u(e,t)},$.pjax.support=f,u});