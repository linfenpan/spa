/**
  @rely: jQuery
  @author: da宗熊
  @version: 0.0.2
  @lastModify: 2017/6/16
  @git: https://github.com/linfenpan/spa#readme
*/
!function(e,t){"function"==typeof define?define.amd?define(t):define.cmd&&define(function(e,r,n){n.exports=t()}):e.SPA=t()}(this,function(){"use strict";function e(e,t){for(var r in e)e.hasOwnProperty(r)&&t.call(e,e[r],r);return e}function t(e){return[].slice.call(e,0)}function r(e){return $.type(e)}function n(e,t){if(f.isAbsolute(e))return e;var r=location.href;return t=t||r,f.isAbsolute(t)||(t=n(t,r)),t=f.dir(t),f.join(t,e)}function i(e){return e.replace(/(\?|#).*$/,"")}function o(){return y++}function a(e){this.key=e,this.keyBack=e+"-back",this.keyForward=e+"-forward",this.current=null,this.bindEvent(),this.init()}function s(e,t){this.key=e,this.waitTime=t||300,this.isRunning=!1,this.runTimer=null,this.prevFn=null}function c(e,t){var r=this;d.call(r),r.$root=e,r.opts=$.extend({key:"pjax",animateTime:300},t||{});var n=r.key=r.opts.key;r.keyContainer="data-"+n+"-container",r.keyIgnore="data-"+n+"-ignore",r.keyResource="data-"+n+"-res",r.keyCurrent="data-"+n+"-current",r.keyId="data-"+n+"-id",r.ajax=null,r.lockAjax=!1,u&&(r.init(),r.bindEvent())}var u="pushState"in history&&!!window.sessionStorage;if(window.sessionStorage)try{sessionStorage.setItem("__pajax",1),sessionStorage.removeItem("__pajax")}catch(f){u=!1}var f={normal:function(e){return e.replace(/\/\.\//g,"//").replace(/(^|[^:])\/{2,}/g,"$1/").replace(/[^/]*\/\.\.\/([^/]*)/g,"$1")},isAbsolute:function(e){return/((https?|ftp):)?\/\//.test(e)},join:function(){var e=[].slice.call(arguments,0),t=e.shift(),r="/",n=!1,i="/";f.isAbsolute(t)&&(r=/.*?:?\/\/[^/]+\/?/.exec(t)[0]+"/",n=/^.*?:?\/\/[^/]+\/?$/.test(t)),n&&(i=r,r="/",t="/");for(var o=e.shift();o;){if(f.isAbsolute(o))return t=o,e.unshift(t),f.join.apply(f,e);t=/^\//.test(o)?f.normal(r+"/"+o):f.normal(f.dir(t)+"/"+o),o=e.shift()}return n?f.normal(i+"./"+t):t},dir:function(e){return e=i(e),f.isDir(e)?f.normal(e):f.normal(e.replace(/(.*\/).*$/,"$1"))},isDir:function(e){return e=f.normal(e),!/(?:[^/])\/[^/]+\.[^/]+$/.test(e)},root:function(e){var t=e.match(/.*:\/{2,}.*?(\/|$)/g);return t?t[0]:""},ext:function(e){return(e=i(e)).match(/\.([^.]*)$/)[1]}},d=function(){this._=$("<div></div>")};d.prototype={on:function(e,r,n){var i=this,o=r._e_on_fn_||function(){var e=t(arguments);return e.shift(),r.apply(i,e)};return i._[n?"one":"on"](e,o),i},off:function(e,t){return this._.off(e,t?t._e_on_fn_||t:t),this},one:function(e,t){return this.on(e,t,!0)},fire:function(){return this._.trigger.apply(this._,arguments),this}};var h=new d,l={elHead:null,map:{},init:function(){var e=this;e.elHead=document.head||document.getElementsByTagName("head")[0],e.init=function(){},$("script,link").each(function(t,r){var n=r.src||r.href;e._setExist(n)})},_setExist:function(e){e&&(f.isAbsolute(e)||(e=n(e)),this.map[e]=1)},_addResource:function(e,t,r,i){var o=this;if(r=r||o.elHead,t){if(i=void 0===i||i,t=n(t),i&&o.map[t])return;r.appendChild(e),i&&o._setExist(t)}else r.appendChild(e)},addScripts:function(t,r){var n=this,i=[];n.init(),e(t,function(t){var r=t.dom,o=t.pos,a=t.ignoreRepeat;if(r){var s=document.createElement("script");if(!r.src)return s.innerHTML=$(r).html(),void $.when.apply($,i.slice(0)).always(function(){n._addResource(s,s.src,o,a)});if(e(r.attributes,function(e){var t=e.name||e.nodeName||e;s.setAttribute(t,r.getAttribute(t))}),!a||!n.map[r.src]){var c=$.Deferred();s.addEventListener("load",c.resolve,!1),s.addEventListener("error",c.resolve,!1),i.push(c)}$.when.apply($,i.slice(0,-1)).always(function(){n._addResource(s,s.src,o,a)})}}),$.when.apply($,i.slice(0)).always(function(){r&&r()})},addLinks:function(t){var r=this;r.init(),e(t,function(e){var t=e.dom;r._addResource(t,t.href,e.pos,e.ignoreRepeat)})}};$(function(){l.init()});var p=sessionStorage,y=new Date/1;return a.prototype={init:function(){if(!this.current){var e=JSON.parse(p.getItem(this.keyBack)||"[]");this.current=e[e.length-1]}},bindEvent:function(){var e=this;window.addEventListener("popstate",function(t){var r=t.state;if(!r||!r.id)return!0;e.onStateChange(r)})},clear:function(){p.setItem(this.keyBack,"[]"),p.setItem(this.keyForward,"[]")},_getList:function(e){return JSON.parse(p.getItem(e)||"[]")},_setList:function(e,t){p.setItem(e,JSON.stringify(t||[]))},push:function(e,t){var r=this,n=r.current,i=$.extend({key:r.key,id:o(),url:e},t||{});history.pushState(i,"",e),r._push(i),h.fire("pushstate",[{key:r.key,from:n,to:i,back:r._getList(r.keyBack),forward:[]}])},_push:function(e){var t=this,r=t._getList(t.keyBack);r.push(e),p.setItem(t.keyBack,JSON.stringify(r)),t._setList(t.keyForward,[]),t.current=e},replace:function(e,t){var r=this,n=r.current,i=$.extend({key:r.key,id:o(),url:e},t||{});history.replaceState(i,"",e),this._replace(i),h.fire("replacestate",[{key:r.key,from:n,to:i,back:r._getList(r.keyBack),foward:r._getList(r.keyForward)}])},_replace:function(e){var t=this,r=t._getList(t.keyBack);r[Math.max(0,r.length-1)]=e,t._setList(t.keyBack,r),t.current=e},_back:function(e){var t=this;t.current=e;var r=t._getList(t.keyBack);r.pop(),t._setList(t.keyBack,r),(r=t._getList(t.keyForward)).unshift(e),t._setList(t.keyForward,r)},_forward:function(e){var t=this;t.current=e;var r=t._getList(t.keyBack);r.push(e),t._setList(t.keyBack,r),(r=t._getList(t.keyForward)).shift(),t._setList(t.keyForward,r)},onStateChange:function(e){var t=this,r=!1,n=t.current;n&&n.id!==e.id&&(n.id>e.id?(r=!0,t._back(e)):t._forward(e)),h.fire("popstate",[{key:t.key,from:n,to:e,isBack:r,back:t._getList(t.keyBack),foward:t._getList(t.keyForward)}])}},s.prototype={getCls:function(e){var t=this.key,r=t+"-"+e;return{beforeShow:r+"-before-show "+t+"-before-show pjax-before-show",show:r+"-show "+t+"-show pjax-show",beforeHide:r+"-before-hide "+t+"-before-hide pjax-before-hide",hide:r+"-hide "+t+"-hide pjax-hide"}},clearCls:function(e){var t=e[0];if(t){var r=new RegExp("(\\s+)"+this.key+"(-[^-]+)+-(show|hide)\\s*","g");t.className=t.className.replace(r,"$1")}},animate:function(e,t,r,n){var i=this,o=i.getCls(e);i.clearCls(t),i.clearCls(r),t.addClass(o.beforeHide),r.addClass(o.beforeShow),t[0]&&t[0].clientWidth,r[0]&&r[0].clientWidth,clearTimeout(i.runTimer),i.isRunning&&i.prevFn&&i.prevFn(),i.prevFn=function(){i.isRunning=!1,t.addClass(o.hide),r.addClass(o.show),n&&n()},i.isRunning=!0,i.runTimer=setTimeout(i.prevFn,i.waitTime)}},c.prototype=$.extend({init:function(){var e=this,t=this.$root,r=this.opts,n=t.find("["+e.keyContainer+"]");if(n.length>1)throw"["+e.keyContainer+"] 元素，同一个页面，不能有多个";var i=e.history=new a(e.key);if(history.state||i.clear(),i.replace(location.href),n.length>0){var o=i.current;e._setDomIdByConf(n,o),e._setDomState(n,!0)}e.clsCtrl=new s(e.key,r.animateTime)},_setDomIdByConf:function(e,t){e.attr(this.keyId,t.id)},_setDomState:function(e,t){t?e.attr(this.keyCurrent,!0):e.removeAttr(this.keyCurrent)},bindEvent:function(){function t(t){var n={};e([].concat(t.back||[],t.forward||[]),function(e){n[e.id]=1}),r.$root.find("["+r.keyId+"]").each(function(e,t){var i=$(t),o=i.attr(r.keyId);n[o]||setTimeout(function(){r.fire("dom:destroy",[i]),i.remove()},r.opts.animateTime)})}var r=this,n=r.opts.key;h.on("pushstate",function(e){e&&e.key==n&&t(e)}),h.on("popstate",function(e){if(e&&e.key==n&&e.to){t(e);var i=e.to.url,o=e.isBack?"back":"forward",a=r.$root.find("["+r.keyId+"="+e.to.id+"]");a.length>0?r._addContent({$dom:a},o):r._load(i,o,!0)}})},back:function(e){history.back()},forward:function(e){history.forward()},push:function(e){u?this._load(e,"push"):location.href=e},replace:function(e){u?this._load(e,"replace"):location.replace(e)},reload:function(e){u?this._load(e||location.href,"replace",!0):location.reload()},_load:function(e,i,o){var a=this;"object"===r(e)&&(e=e.href||"");var s=n(e);if((o||s!==location.href)&&!a.lockAjax)return a.fire("pjax:request",[s].concat(t(arguments))),a.ajax&&a.ajax.abort(),a.ajax=$.get(s,{},$.noop,"html").always(function(){a.fire("pjax:complete",[s].concat(t(arguments)))}).done(function(e){a.fire("pjax:success",[s].concat(t(arguments))),a.handlerSuccess(s,i,e)}).fail(function(){a.fire("pjax:failure",[s].concat(t(arguments)))}),a.ajax},handlerSuccess:function(e,t,r){var n=this;n.lockAjax=!0;try{var i=n._analysisiHtml(r,e);if(!i.$dom||i.$dom.length<=0)return n.lockAjax=!1,void n.fire("pjax:parseerror",[e,r]);n._addContent(i,t,function(r,i){switch(n.lockAjax=!1,t){case"push":n.history.push(e),n._setDomIdByConf(i,n.history.current);break;case"replace":n.history.replace(e),n.fire("dom:destroy",[r]),r.remove(),n._setDomIdByConf(i,n.history.current)}})}catch(t){n.lockAjax=!1,n.fire("pjax:parseerror",[e,r])}},_analysisiHtml:function(e,t){var r=this,i=document.head||document.getElementsByTagName("head")[0],o=e.match(/<body[^>]*>([\s\S.]*)<\/body>/),a=e.match(/<head[^>]*>([\s\S.]*)<\/head>/),s=[],c=[],u=null,f=null,d=null;o&&(f=$("<div>"+o[1]+"</div>")),a&&(d=$("<div>"+a[1]+"</head>"));var h="link["+r.keyIgnore+"],style["+r.keyIgnore+"],script["+r.keyIgnore+"]",l=function(e,i){var o=e.getAttribute(r.keyResource);return e.href?e.setAttribute("href",n(e.getAttribute("href"),t)):e.src&&e.setAttribute("src",n(e.getAttribute("src"),t)),{dom:e,pos:i,ignoreRepeat:0==o||!o}};return d&&(f.find(h).remove(),d.find("style,link,script").each(function(e,t){var r=c;"script"===t.tagName.toLowerCase()&&(r=s),r.push(l(t,i))})),f&&(f.find(h).remove(),u=f.find("["+r.keyContainer+"]"),f.find("script").map(function(e,t){$(t),u.find(t).length>0?(t.setAttribute(r.keyResource,t.getAttribute(r.keyResource)||1),s.push(l(t,u[0]))):t.hasAttribute(r.keyResource)&&s.push(l(t,i))}),u.find("script").remove(),u.remove(),f.find("style,link").each(function(e,t){t.hasAttribute(r.keyResource)&&c.push(l(t,i))})),{scripts:s,links:c,$dom:u}},_addContent:function(e,t,r){var n=this;if(e.$dom&&1===e.$dom.length){n.$root.append(e.$dom);var i=e.$dom,o=n.$root.find("["+n.keyCurrent+"]"),a=$.Deferred(),s=$.Deferred();l.addScripts(e.scripts,function(){a.resolve()}),l.addLinks(e.links),$.when(a,s).always(function(){n.fire("pjax:render",[i]),n.fire("dom:ready",[i])}),n.fire("dom:beforeshow",[i]),n.fire("dom:beforehide",[o]),n.clsCtrl.animate(t||"replace",o,i,function(){n._setDomState(i,!0),n._setDomState(o,!1),n.fire("dom:show",[i]),n.fire("dom:hide",[o]),s.resolve(),r&&r(o,i)})}else console.error("缺少 dom 元素")}},d.prototype),$.pjax=function(e,t){return new c(e,t)},$.pjax.support=u,c});