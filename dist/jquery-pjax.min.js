/**
  @rely: jQuery
  @author: da宗熊
  @version: 0.0.6
  @lastModify: 2019/4/30
  @git: https://github.com/linfenpan/spa#readme
*/
!function(e,i){"function"==typeof define?define.amd?define(i):define.cmd&&define(function(e,t,n){n.exports=i()}):e.Pjax=i()}(this,function(){"use strict";var s="popstate",c="pushstate",o="pushState"in history&&!!window.sessionStorage;if(window.sessionStorage)try{var e="__pajax";sessionStorage.setItem(e,1),sessionStorage.removeItem(e)}catch(e){o=!1}function u(e,t){for(var n in e)e.hasOwnProperty(n)&&t.call(e,e[n],n);return e}function a(e){return[].slice.call(e,0)}function f(e){return $.type(e)}function k(e,t){if(h.isAbsolute(e))return e;var n=location.href;return t=t||n,h.isAbsolute(t)||(t=k(t,n)),t=h.dir(t),h.join(t,e)}function t(e){return e.replace(/(\?|#).*$/,"")}function d(){this._=$("<div></div>")}var h={normal:function(e){return e.replace(/\/\.\//g,"//").replace(/(^|[^:])\/{2,}/g,"$1/").replace(/[^/]*\/\.\.\/([^/]*)/g,"$1")},isAbsolute:function(e){return/((https?|ftp):)?\/\//.test(e)},join:function(){var e=[].slice.call(arguments,0),t=e.shift(),n="/",i=!1,r="/";h.isAbsolute(t)&&(n=/.*?:?\/\/[^/]+\/?/.exec(t)[0]+"/",i=/^.*?:?\/\/[^/]+\/?$/.test(t)),i&&(r=n,t=n="/");for(var o=e.shift();o;){if(h.isAbsolute(o))return t=o,e.unshift(t),h.join.apply(h,e);t=/^\//.test(o)?h.normal(n+"/"+o):h.normal(h.dir(t)+"/"+o),o=e.shift()}return i?h.normal(r+"./"+t):t},dir:function(e){return e=t(e),h.isDir(e)?h.normal(e):h.normal(e.replace(/(.*\/).*$/,"$1"))},isDir:function(e){return e=h.normal(e),!/(?:[^/])\/[^/]+\.[^/]+$/.test(e)},root:function(e){var t=e.match(/.*:\/{2,}.*?(\/|$)/g);return t?t[0]:""},ext:function(e){return(e=t(e)).match(/\.([^.]*)$/)[1]}},l="_e_on_fn_";d.prototype={on:function(e,t,n){var i=this,r=t[l]||function(){var e=a(arguments);return e.shift(),t.apply(i,e)};return i._[n?"one":"on"](e,r),i},off:function(e,t){return this._.off(e,t&&t[l]||t),this},one:function(e,t){return this.on(e,t,!0)},fire:function(){return this._.trigger.apply(this._,arguments),this}};var p=new d,y={elHead:null,map:{},init:function(){var i=this;i.elHead=document.head||document.getElementsByTagName("head")[0],i.init=function(){},$("script,link").each(function(e,t){var n=t.src||t.href;i._setExist(n)})},_setExist:function(e){e&&(h.isAbsolute(e)||(e=k(e)),this.map[e]=1)},_addResource:function(e,t,n,i){if(n=n||this.elHead,t){if(i=void 0===i||i,t=k(t),i&&this.map[t])return;n.appendChild(e),i&&this._setExist(t)}else n.appendChild(e)},addScripts:function(e,t){var a=this,s=[];a.init(),u(e,function(e){var n=e.dom,t=e.pos,i=e.ignoreRepeat;if(n){var r=document.createElement("script");if(!n.src)return r.innerHTML=$(n).html(),void $.when.apply($,s.slice(0)).always(function(){a._addResource(r,r.src,t,i)});if(u(n.attributes,function(e){var t=e.name||e.nodeName||e;r.setAttribute(t,n.getAttribute(t))}),!i||!a.map[n.src]){var o=$.Deferred();r.addEventListener("load",o.resolve,!1),r.addEventListener("error",o.resolve,!1),s.push(o)}$.when.apply($,s.slice(0,-1)).always(function(){a._addResource(r,r.src,t,i)})}}),$.when.apply($,s.slice(0)).always(function(){t&&t()})},addLinks:function(e){var n=this;n.init(),u(e,function(e){var t=e.dom;n._addResource(t,t.href,e.pos,e.ignoreRepeat)})}};$(function(){y.init()});var i=sessionStorage,n=new Date/1;function m(){return n++}function v(e){this.key=e,this.keyBack=e+"-back",this.keyForward=e+"-forward",this.current=null,this.bindEvent(),this.init()}function g(e,t){this.key=e,this.waitTime=t||300,this.isRunning=!1,this.runTimer=null,this.prevFn=null}function _(e){this.map={},this.split=e||"-",this.args=[]}v.prototype={init:function(){if(!this.current){var e=JSON.parse(i.getItem(this.keyBack)||"[]");this.current=e[e.length-1]}},bindEvent:function(){var n=this;window.addEventListener("popstate",function(e){var t=e.state;if(!t||!t.id)return!0;n.onStateChange(t)})},clear:function(){i.setItem(this.keyBack,"[]"),i.setItem(this.keyForward,"[]")},_getList:function(e){return JSON.parse(i.getItem(e)||"[]")},_setList:function(e,t){i.setItem(e,JSON.stringify(t||[]))},push:function(e,t){var n=this,i=n.current,r=$.extend({key:n.key,id:m(),url:e},t||{});history.pushState(r,"",e),n._push(r),p.fire(c,[{key:n.key,from:i,to:r,back:n._getList(n.keyBack),forward:[]}])},_push:function(e){var t=this,n=t._getList(t.keyBack);n.push(e),i.setItem(t.keyBack,JSON.stringify(n)),t._setList(t.keyForward,[]),t.current=e},replace:function(e,t){var n=this,i=n.current,r=$.extend({key:n.key,id:m(),url:e},t||{});history.replaceState(r,"",e),this._replace(r),p.fire("replacestate",[{key:n.key,from:i,to:r,back:n._getList(n.keyBack),forward:n._getList(n.keyForward)}])},_replace:function(e){var t=this,n=t._getList(t.keyBack);n[Math.max(0,n.length-1)]=e,t._setList(t.keyBack,n),t.current=e},_back:function(e){var t=this;t.current=e;var n=t._getList(t.keyBack);n.pop(),t._setList(t.keyBack,n),(n=t._getList(t.keyForward)).unshift(e),t._setList(t.keyForward,n)},_forward:function(e){var t=this;t.current=e;var n=t._getList(t.keyBack);n.push(e),t._setList(t.keyBack,n),(n=t._getList(t.keyForward)).shift(),t._setList(t.keyForward,n)},onStateChange:function(e){var t=this,n=!1,i=t.current;i&&i.id!==e.id&&(i.id>e.id?(n=!0,t._back(e)):t._forward(e)),p.fire(s,[{key:t.key,from:i,to:e,isBack:n,back:t._getList(t.keyBack),forward:t._getList(t.keyForward)}])}},g.prototype={getCls:function(e){var t=this.key,n=t+"-"+e;return{beforeShow:n+"-before-show "+t+"-before-show pjax-before-show",show:n+"-show "+t+"-show pjax-show",beforeHide:n+"-before-hide "+t+"-before-hide pjax-before-hide",hide:n+"-hide "+t+"-hide pjax-hide"}},clearCls:function(e){var t=e[0];if(t){var n=new RegExp("(\\s+)"+this.key+"(-[^-]+)+-(show|hide)\\s*","g");t.className=t.className.replace(n,"$1")}},animate:function(e,t,n,i){var r=this,o=r.getCls(e);r.clearCls(t),r.clearCls(n),t.addClass(o.beforeHide),n.addClass(o.beforeShow),t[0]&&t[0].clientWidth,n[0]&&n[0].clientWidth,clearTimeout(r.runTimer),r.isRunning&&r.prevFn&&r.prevFn(),r.prevFn=function(){r.isRunning=!1,t.addClass(o.hide),n.addClass(o.show),i&&i()},r.isRunning=!0,r.runTimer=setTimeout(r.prevFn,r.waitTime)}},_.prototype={params:function(){return this.args=a(arguments),this},add:function(){var e=a(arguments),t=e.pop();if("function"==f(t))return this.map[e.join(this.split)]=t,this},run:function(){var e=a(arguments),t=this.map[e.join(this.split)];return t&&t.apply(null,this.args),this}};var w="pjax:render",b="pjax:parseerror",x="dom:ready",C="repeat",j="ignore",S="once",L="inlineScript";function r(e,t){var n=this;d.call(n),n.$root=e,n.opts=$.extend({key:"pjax",cache:!0,animateTime:300,fireInitEvent:!0,resourceLoadConfig:{body:{},head:{},container:{},other:{}}},t||{});var i=n.key=n.opts.key;if(n.keyContainer="data-"+i+"-container",n.keyResource="data-"+i+"-res",n.keyCurrent="data-"+i+"-current",n.keyId="data-"+i+"-id",n.ajax=null,n.lockAjax=!1,o)n.init(),n.bindEvent();else{var r=e.find("["+n.keyContainer+"]");n.opts.fireInitEvent&&setTimeout(function(){n.fire(x,[location.href,r])})}}return r.prototype=$.extend({init:function(){var e=this,t=this.$root,n=this.opts,i=t.find("["+e.keyContainer+"]");if(1<i.length)throw"["+e.keyContainer+"] 元素，同一个页面，不能有多个";var r=e.history=new v(e.key);history.state||r.clear();var o=location.href;if(r.replace(o),0<i.length){var a=r.current;e._setDomIdByConf(i,a),e._setDomState(i,!0),n.fireInitEvent&&setTimeout(function(){e.fire(w,[o,i]),e.fire(x,[o,i])})}e.clsCtrl=new g(e.key,n.animateTime),e.stateRunner=new _,e.initRunner()},initRunner:function(){var n=this,e=n.stateRunner,t="history";e.add(t,"push",function(e){n.history.push(e)}),e.add(t,"replace",function(e){n.history.replace(e)}),t="dom",e.add(t,"push",function(e,t){n._setDomIdByConf(t,n.history.current)}),e.add(t,"replace",function(e,t){n.fire("dom:destroy",[e]),e.remove(),n._setDomIdByConf(t,n.history.current)})},_setDomIdByConf:function(e,t){e.attr(this.keyId,t.id)},_setDomState:function(e,t){t?e.attr(this.keyCurrent,!0):e.removeAttr(this.keyCurrent)},bindEvent:function(){var o=this,r=o.opts.key;function a(e){var t=[].concat(e.back||[],e.forward||[]),r={};u(t,function(e){r[e.id]=1}),o.$root.find("["+o.keyId+"]").each(function(e,t){var n=$(t),i=n.attr(o.keyId);r[i]||setTimeout(function(){o.fire("dom:destroy",[n]),n.remove()},o.opts.animateTime)})}p.on(c,function(e){e&&e.key==r&&a(e)}),p.on(s,function(e){if(e&&e.key==r&&e.to){a(e);var t=e.to.url,n=e.isBack?"back":"forward",i=o.$root.find("["+o.keyId+"="+e.to.id+"]");0<i.length?o._addContent({$dom:i},t,n):o._load(t,n,!0)}})},back:function(e){history.back()},forward:function(e){history.forward()},push:function(e,t){o?this._load(e,"push",!1,t):location.href=e},replace:function(e,t){o?this._load(e,"replace",!1,t):location.replace(e)},reload:function(e,t){"boolean"==typeof e&&(t=e,e=void 0),o?this._load(e||location.href,"replace",!0,t):location.reload()},_load:function(e,t,n,i){var r=this;"object"===f(e)&&(e=e.href||"");var o=k(e);if((n||o!==location.href)&&!r.lockAjax)return r.fire("pjax:request",[o].concat(a(arguments))),r.ajax&&r.ajax.abort(),r.ajax=$.ajax({url:o,type:"GET",cache:void 0===i?r.opts.cache:i,dataType:"html"}).always(function(){r.fire("pjax:complete",[o].concat(a(arguments)))}).done(function(e){r.fire("pjax:success",[o].concat(a(arguments))),r.handlerSuccess(o,t,e)}).fail(function(){r.fire("pjax:failure",[o].concat(a(arguments)))}),r.ajax},handlerSuccess:function(e,n,t){var i=this;i.lockAjax=!0;try{var r=i.stateRunner;r.params(e).run("history",n);var o=i._analysisiHtml(t,e);if(!o.$dom||o.$dom.length<=0)return i.lockAjax=!1,void i.fire(b,[e,t,n]);i._addContent(o,e,n,function(e,t){i.lockAjax=!1,r.params(e,t).run("dom",n)})}catch(o){i.lockAjax=!1,i.fire(b,[e,t,n])}},_getResLoadMode:function(e,t,n){return((this.opts.resourceLoadConfig||{})[e]||{})[t]||n},_analysisiHtml:function(e,s){var c,u=this,f=u.keyResource,d=document.head||document.getElementsByTagName("head")[0],t=e.match(/<body[^>]*>([\s\S.]*)<\/body>/),n=e.match(/<head[^>]*>([\s\S.]*)<\/head>/),h=[],l=[],i=null,r=null,o=null;function a(e,t,n){var i,r,o=e.getAttribute(f),a=e.tagName.toLowerCase();switch(n=n||[],e.href?(i=l,e.setAttribute("href",k(e.getAttribute("href"),s))):e.src?(i=h,e.setAttribute("src",k(e.getAttribute("src"),s))):"script"===a?(i=h,a=L):i=l,a){case L:case"style":r=c;break;case"script":case"link":r=o===C?c:d}o||(o=u._getResLoadMode(t,a,n[a])),i&&r&&o!=j&&i.push({dom:e,pos:r,ignoreRepeat:o==S||!o})}t&&(r=$("<div>"+t[1]+"</div>"),i=r.find("["+u.keyContainer+"]"),c=i[0]),n&&(o=$("<div>"+n[1]+"</head>"));var p=f+"=ignore",y="link["+p+"],style["+p+"],script["+p+"]",m="script,link,style";return o&&(r.find(y).remove(),o.find(m).each(function(e,t){a(t,"head",{inlineScript:C,script:S,style:C,link:S})})),r&&(r.find(y).remove(),r.find(m).map(function(e,t){var n=$(t);0<i.find(t).length?a(t,"container",{inlineScript:C,script:C,style:C,link:C}):n.parent().is(r)?a(t,"body",{inlineScript:C,script:S,style:C,link:S}):a(t,"other",{inlineScript:j,script:j,style:j,link:j})}),i.find(m).remove(),i.remove()),{scripts:h,links:l,$dom:i}},_addContent:function(e,t,n,i){var r=this;if(e.$dom&&1===e.$dom.length){r.$root.append(e.$dom);var o=e.$dom,a=r.$root.find("["+r.keyCurrent+"]"),s=$.Deferred(),c=$.Deferred();y.addLinks(e.links),y.addScripts(e.scripts,function(){s.resolve()}),$.when(s,c).always(function(){r.fire(w,[t,o]),r.fire(x,[t,o])}),r.fire("dom:beforeshow",[t,o]),r.fire("dom:beforehide",[t,a]),r.clsCtrl.animate(n||"replace",a,o,function(){r._setDomState(o,!0),r._setDomState(a,!1),r.fire("dom:show",[t,o]),r.fire("dom:hide",[t,a]),c.resolve(),i&&i(a,o)})}else console.error("缺少 dom 元素")}},d.prototype),$.pjax=function(e,t){return new r(e,t)},$.pjax.support=o,r});