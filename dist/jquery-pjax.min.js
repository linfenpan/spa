/**
  @rely: jQuery
  @author: da宗熊
  @version: 0.0.1
  @lastModify: 2017/6/12
  @git: https://github.com/linfenpan/spa#readme
*/
!function(e,t){"function"==typeof define?define.amd?define(t):define.cmd&&define(function(e,n,r){r.exports=t()}):e.SPA=t()}(this,function(){"use strict";function e(e,t){for(var n in e)e.hasOwnProperty(n)&&t.call(e,e[n],n);return e}function t(e){return[].slice.call(e,0)}function n(e){return $.type(e)}function r(e,t){if(f.isAbsolute(e))return e;var n=location.href;return t=t||n,f.isAbsolute(t)||(t=r(t,n)),t=f.dir(t),f.join(t,e)}function i(e){return e.replace(/(\?|#).*$/,"")}function o(){return y++}function a(e){this.key=e,this.keyBack=e+"-back",this.keyForward=e+"-forward",this.current=null,this.bindEvent(),this.init()}function s(e,t){this.key=e,this.waitTime=t||300,this.isRunning=!1,this.runTimer=null,this.prevFn=null}function c(e,t){var n=this;d.call(n),n.$root=e,n.opts=$.extend({key:"pjax",animateTime:300},t||{});var r=n.key=n.opts.key;n.keyContainer="data-"+r+"-container",n.keyIgnore="data-"+r+"-ignore",n.keyResource="data-"+r+"-res",n.keyCurrent="data-"+r+"-current",n.keyId="data-"+r+"-id",n.ajax=null,n.lockAjax=!1,u&&(n.init(),n.bindEvent())}var u="pushState"in history&&!!window.sessionStorage;if(window.sessionStorage)try{sessionStorage.setItem("__pajax",1),sessionStorage.removeItem("__pajax")}catch(f){u=!1}var f={normal:function(e){return e.replace(/\/\.\//g,"//").replace(/(^|[^:])\/{2,}/g,"$1/").replace(/[^/]*\/\.\.\/([^/]*)/g,"$1")},isAbsolute:function(e){return/((https?|ftp):)?\/\//.test(e)},join:function(){var e=[].slice.call(arguments,0),t=e.shift(),n="/",r=!1,i="/";f.isAbsolute(t)&&(n=/.*?:?\/\/[^/]+\/?/.exec(t)[0]+"/",r=/^.*?:?\/\/[^/]+\/?$/.test(t)),r&&(i=n,n="/",t="/");for(var o=e.shift();o;){if(f.isAbsolute(o))return t=o,e.unshift(t),f.join.apply(f,e);t=/^\//.test(o)?f.normal(n+"/"+o):f.normal(f.dir(t)+"/"+o),o=e.shift()}return r?f.normal(i+"./"+t):t},dir:function(e){return e=i(e),f.isDir(e)?f.normal(e):f.normal(e.replace(/(.*\/).*$/,"$1"))},isDir:function(e){return e=f.normal(e),!/(?:[^/])\/[^/]+\.[^/]+$/.test(e)},root:function(e){var t=e.match(/.*:\/{2,}.*?(\/|$)/g);return t?t[0]:""},ext:function(e){return(e=i(e)).match(/\.([^.]*)$/)[1]}},d=function(){this._=$("<div></div>")};d.prototype={on:function(e,n,r){var i=this,o=n._e_on_fn_||function(){var e=t(arguments);return e.shift(),n.apply(this,e)};return i._[r?"one":"on"](e,o),i},off:function(e,t){return this._.off(e,t?t._e_on_fn_||t:t),this},one:function(e,t){return this.on(e,t,!0)},fire:function(){return this._.trigger.apply(this._,arguments),this}};var h=new d,l={elHead:null,map:{},init:function(){var e=this;e.elHead=document.head||document.getElementsByTagName("head")[0],e.init=function(){},$("script,link").each(function(t,n){var r=n.src||n.href;e._setExist(r)})},_setExist:function(e){e&&(f.isAbsolute(e)||(e=r(e)),this.map[e]=1)},_addResource:function(e,t,n,i){var o=this;if(n=n||o.elHead,t){if(i=void 0===i||i,t=r(t),i&&o.map[t])return;n.appendChild(e),i&&o._setExist(t)}else n.appendChild(e)},addScripts:function(t,n){var r=this,i=[];r.init(),e(t,function(t){var n=t.dom,o=t.pos,a=t.ignoreRepeat;if(n){var s=document.createElement("script");if(!n.src)return s.innerHTML=$(n).html(),void $.when.apply($,i.slice(0)).always(function(){r._addResource(s,s.src,o,a)});if(e(n.attributes,function(e){var t=e.name||e.nodeName||e;s.setAttribute(t,n.getAttribute(t))}),!a||!r.map[n.src]){var c=$.Deferred();s.addEventListener("load",c.resolve,!1),s.addEventListener("error",c.resolve,!1),i.push(c)}$.when.apply($,i.slice(0,-1)).always(function(){r._addResource(s,s.src,o,a)})}}),$.when.apply($,i.slice(0)).always(function(){n&&n()})},addLinks:function(t){var n=this;n.init(),e(t,function(e){var t=e.dom;n._addResource(t,t.href,e.pos,e.ignoreRepeat)})}};$(function(){l.init()});var p=sessionStorage,y=new Date/1;return a.prototype={init:function(){if(!this.current){var e=JSON.parse(p.getItem(this.keyBack)||"[]");this.current=e[e.length-1]}},bindEvent:function(){var e=this;window.addEventListener("popstate",function(t){var n=t.state;if(!n||!n.id)return!0;e.onStateChange(n)})},clear:function(){p.setItem(this.keyBack,"[]"),p.setItem(this.keyForward,"[]")},_getList:function(e){return JSON.parse(p.getItem(e)||"[]")},_setList:function(e,t){p.setItem(e,JSON.stringify(t||[]))},push:function(e,t){var n=this,r=n.current,i=$.extend({key:n.key,id:o(),url:e},t||{});history.pushState(i,"",e),n._push(i),h.fire("pushstate",[{key:n.key,from:r,to:i,back:n._getList(n.keyBack),forward:[]}])},_push:function(e){var t=this,n=t._getList(t.keyBack);n.push(e),p.setItem(t.keyBack,JSON.stringify(n)),t._setList(t.keyForward,[]),t.current=e},replace:function(e,t){var n=this,r=n.current,i=$.extend({key:n.key,id:o(),url:e},t||{});history.replaceState(i,"",e),this._replace(i),h.fire("replacestate",[{key:n.key,from:r,to:i,back:n._getList(n.keyBack),foward:n._getList(n.keyForward)}])},_replace:function(e){var t=this,n=t._getList(t.keyBack);n[Math.max(0,n.length-1)]=e,t._setList(t.keyBack,n),t.current=e},_back:function(e){var t=this;t.current=e;var n=t._getList(t.keyBack);n.pop(),t._setList(t.keyBack,n),(n=t._getList(t.keyForward)).unshift(e),t._setList(t.keyForward,n)},_forward:function(e){var t=this;t.current=e;var n=t._getList(t.keyBack);n.push(e),t._setList(t.keyBack,n),(n=t._getList(t.keyForward)).shift(),t._setList(t.keyForward,n)},onStateChange:function(e){var t=this,n=!1,r=t.current;r&&r.id!==e.id&&(r.id>e.id?(n=!0,t._back(e)):t._forward(e)),h.fire("popstate",[{key:t.key,from:r,to:e,isBack:n,back:t._getList(t.keyBack),foward:t._getList(t.keyForward)}])}},s.prototype={getCls:function(e){var t=this.key,n=t+"-"+e;return{beforeShow:n+"-before-show "+t+"-before-show",show:n+"-show "+t+"-show",beforeHide:n+"-before-hide "+t+"-before-hide",hide:n+"-hide "+t+"-hide"}},clearCls:function(e){var t=e[0];if(t){var n=new RegExp("(\\s+)"+this.key+"(-[^-]+)+-(show|hide)\\s*","g");t.className=t.className.replace(n,"$1")}},animate:function(e,t,n,r){var i=this,o=i.getCls(e);i.clearCls(t),i.clearCls(n),t.addClass(o.beforeHide),n.addClass(o.beforeShow),t[0]&&t[0].clientWidth,n[0]&&n[0].clientWidth,clearTimeout(i.runTimer),i.isRunning&&i.prevFn&&i.prevFn(),i.prevFn=function(){i.isRunning=!1,t.addClass(o.hide),n.addClass(o.show),r&&r()},i.isRunning=!0,i.runTimer=setTimeout(i.prevFn,i.waitTime)}},c.prototype=$.extend({init:function(){var e=this,t=this.$root,n=this.opts,r=t.find("["+e.keyContainer+"]");if(r.length>1)throw"["+e.keyContainer+"] 元素，同一个页面，不能有多个";var i=e.history=new a(e.key);if(history.state||i.clear(),i.replace(location.href),r.length>0){var o=i.current;e._setDomIdByConf(r,o),e._setDomState(r,!0)}e.clsCtrl=new s(e.key,n.animateTime)},_setDomIdByConf:function(e,t){e.attr(this.keyId,t.id)},_setDomState:function(e,t){t?e.attr(this.keyCurrent,!0):e.removeAttr(this.keyCurrent)},bindEvent:function(){function t(t){var r={};e([].concat(t.back||[],t.forward||[]),function(e){r[e.id]=1}),n.$root.find("["+n.keyId+"]").each(function(e,t){var i=$(t),o=i.attr(n.keyId);r[o]||setTimeout(function(){n.fire("dom:destroy",[i]),i.remove()},n.opts.animateTime)})}var n=this,r=n.opts.key;h.on("pushstate",function(e){e&&e.key==r&&t(e)}),h.on("popstate",function(e){if(e&&e.key==r&&e.to){t(e);var i=e.to.url,o=e.isBack?"back":"forward",a=n.$root.find("["+n.keyId+"="+e.to.id+"]");a.length>0?n._addContent({$dom:a},o):n.load(i,o,!0)}})},back:function(e){history.back()},forward:function(e){history.forward()},push:function(e){u?this.load(e,"push"):location.href=e},replace:function(e){u?this.load(e,"replace"):location.replace(e)},reload:function(e){u?this.load(e||location.href,"replace",!0):location.reload()},load:function(e,i,o){var a=this;"object"===n(e)&&(e=e.href||"");var s=r(e);if((o||s!==location.href)&&!a.lockAjax)return a.fire("pjax:request",[s].concat(t(arguments))),a.ajax&&a.ajax.abort(),a.ajax=$.get(s,{},$.noop,"html").always(function(){a.fire("pjax:complete",[s].concat(t(arguments)))}).done(function(e){a.fire("pjax:success",[s].concat(t(arguments))),a.handlerSuccess(s,i,e)}).fail(function(){a.fire("pjax:failure",[s].concat(t(arguments)))}),a.ajax},handlerSuccess:function(e,t,n){var r=this;r.lockAjax=!0;try{var i=r._analysisiHtml(n,e);r._addContent(i,t,function(n,i){switch(r.lockAjax=!1,t){case"push":r.history.push(e),r._setDomIdByConf(i,r.history.current);break;case"replace":r.history.replace(e),r.fire("dom:destroy",[n]),n.remove(),r._setDomIdByConf(i,r.history.current)}})}catch(e){r.lockAjax=!1}},_analysisiHtml:function(e,t){var n=this,i=document.head||document.getElementsByTagName("head")[0],o=e.match(/<body[^>]*>([\s\S.]*)<\/body>/),a=e.match(/<head[^>]*>([\s\S.]*)<\/head>/),s=[],c=[],u=null,f=null,d=null;o&&(f=$("<div>"+o[1]+"</div>")),a&&(d=$("<div>"+a[1]+"</head>"));var h="link["+n.keyIgnore+"],style["+n.keyIgnore+"],script["+n.keyIgnore+"]",l=function(e,i){var o=e.getAttribute(n.keyResource);return e.href?e.setAttribute("href",r(e.getAttribute("href"),t)):e.src&&e.setAttribute("src",r(e.getAttribute("src"),t)),{dom:e,pos:i,ignoreRepeat:0==o||!o}};return d&&(f.find(h).remove(),d.find("style,link,script").each(function(e,t){var n=c;"script"===t.tagName.toLowerCase()&&(n=s),n.push(l(t,i))})),f&&(f.find(h).remove(),u=f.find("["+n.keyContainer+"]"),f.find("script").map(function(e,t){$(t),u.find(t).length>0?(t.setAttribute(n.keyResource,t.getAttribute(n.keyResource)||1),s.push(l(t,u[0]))):t.hasAttribute(n.keyResource)&&t.push(l(t,i))}),u.find("script").remove(),u.remove(),f.find("style,link").each(function(e,t){t.hasAttribute(n.keyResource)&&script.push(l(t,i))})),{scripts:s,links:c,$dom:u}},_addContent:function(e,t,n){var r=this;if(e.$dom&&1===e.$dom.length){r.$root.append(e.$dom);var i=e.$dom,o=r.$root.find("["+r.keyCurrent+"]");l.addScripts(e.scripts,function(){r.fire("pjax:render",[i]),r.fire("dom:ready",[i])}),l.addLinks(e.links),r.fire("dom:beforeshow",[i]),r.fire("dom:beforehide",[o]),r.clsCtrl.animate(t||"replace",o,i,function(){r._setDomState(i,!0),r._setDomState(o,!1),r.fire("dom:show",[i]),r.fire("dom:hide",[o]),n&&n(o,i)})}else console.error("缺少 dom 元素")}},d.prototype),$.pjax=function(e,t){return new c(e,t)},$.pjax.support=u,c});